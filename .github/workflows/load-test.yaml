name: K8s Load Test

on:
  push:
    branches: [main, feat/production-hardening]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      rate:
        description: 'Requests per second'
        required: false
        default: '100'
      duration:
        description: 'Test duration (e.g., 30s, 1m)'
        required: false
        default: '30s'
      fail_rate:
        description: 'Percentage of requests to fail (0-100)'
        required: false
        default: '0'

env:
  CLUSTER_NAME: load-test-cluster
  NAMESPACE: echo-test

permissions:
  contents: write
  pull-requests: write

jobs:
  # ========================================
  # Validate - Fail Fast
  # ========================================
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          echo "Validating YAML files..."
          find . -name '*.yaml' -o -name '*.yml' | while read file; do
            echo "  Checking $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
          echo "All YAML files are valid"

      - name: Validate Python syntax
        run: |
          echo "Checking Python syntax..."
          python3 -m py_compile scripts/run-load-test.py
          echo "Python syntax valid"

      - name: Validate K8s manifests
        run: |
          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

          # Install kubeconform
          wget -q https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform-linux-amd64.tar.gz

          # Build + validate in one pass
          echo "Building and validating K8s manifests..."
          kustomize build k8s/overlays/ci | ./kubeconform -strict -summary
          echo "All manifests valid"

  # ========================================
  # Load Test - Main Job
  # ========================================
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate

    steps:
      # ========================================
      # Setup
      # ========================================
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d version

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Install Vegeta
        run: |
          wget -q https://github.com/tsenart/vegeta/releases/download/v12.11.1/vegeta_12.11.1_linux_amd64.tar.gz
          tar -xzf vegeta_12.11.1_linux_amd64.tar.gz
          sudo mv vegeta /usr/local/bin/
          vegeta --version

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
          kustomize version

      # ========================================
      # Create Cluster
      # ========================================
      - name: Create k3d cluster
        run: |
          k3d cluster create --config k3d/cluster-config.yaml
          kubectl cluster-info
          kubectl get nodes

      # ========================================
      # Install Infrastructure
      # ========================================
      - name: Install NGINX Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.5/deploy/static/provider/cloud/deploy.yaml
          echo "Waiting for NGINX Ingress Controller..."
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Install Prometheus (kube-prometheus-stack)
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          helm install prometheus prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --create-namespace \
            --values monitoring/prometheus-values.yaml \
            --wait \
            --timeout 5m
        continue-on-error: true  # Don't fail if Prometheus install fails

      # ========================================
      # Deploy Application
      # ========================================
      - name: Deploy application
        run: |
          kustomize build k8s/overlays/ci | kubectl apply -f -
          kubectl get all -n $NAMESPACE

      # ========================================
      # Run Load Test
      # ========================================
      - name: Run load test
        id: loadtest
        run: |
          set +e  # Don't exit on error
          python scripts/run-load-test.py \
            --namespace $NAMESPACE \
            --rate ${{ github.event.inputs.rate || '100' }} \
            --duration ${{ github.event.inputs.duration || '30s' }} \
            --fail-rate ${{ github.event.inputs.fail_rate || '10' }} \
            --output-dir ./results
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Continue to post results

      # ========================================
      # Post Results
      # ========================================
      - name: Read report
        id: report
        if: always()
        run: |
          if [ -f ./results/report.md ]; then
            # Use GitHub's multiline output format
            echo "content<<EOF" >> $GITHUB_OUTPUT
            cat ./results/report.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "content=## Load Test Results\n\n**Error:** No report generated. Check workflow logs." >> $GITHUB_OUTPUT
          fi

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: ./results/
          retention-days: 7

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('./results/report.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Load Test Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ========================================
      # Fail if tests failed (blocks PR merge)
      # ========================================
      - name: Check test results
        if: always()
        run: |
          if [ "${{ steps.loadtest.outputs.exit_code }}" != "0" ]; then
            echo "::error::Load test failed with exit code ${{ steps.loadtest.outputs.exit_code }}"
            exit 1
          fi
          echo "Load test passed!"

      # ========================================
      # Cleanup
      # ========================================
      - name: Cleanup cluster
        if: always()
        run: |
          k3d cluster delete $CLUSTER_NAME || true

      # ========================================
      # Auto-merge PR if tests passed
      # ========================================
      - name: Auto-merge PR
        if: github.event_name == 'pull_request' && steps.loadtest.outputs.exit_code == '0' && github.head_ref != 'feat/production-hardening'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto
